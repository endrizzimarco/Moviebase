.album
  .container
    .row
      .col-sm-4
        %img.img-fluid{src: @movie.img_path, alt: 'Poster'}

      #movieDetails.col-sm-8
        %h1#movietitle.textborder
          = @movie.title
          -# Registered user only features
          -if not current_user.present?
          -elsif not current_user.movies.exists?(api_id: @movie.api_id)
            %button.btn.btn-default.btn-lg= t('.addMovie')
          -elsif not current_user.favourite_movies.exists?(id: @movie.id) 
            %span.submit= link_to '', favourite_movies_path(id: @movie.id), method: :post, class: 'glyphicon glyphicon-star-empty star'
          -else 
            %span.submit= link_to '', favourite_movie_path(id: @movie.id), method: :delete, class: 'glyphicon glyphicon-star star'
          %a.toggle See Reviews
        %h4.textborder= @movie.tagline
        %br
        #addmovie{hidden: ''}
          = form_with url: movies_path do |f|
            #ratyjs
            =hidden_field_tag 'id', @movie.id
            %input.submit.btn.btn-default{type: 'submit', value: t('.submit')}
        %p.textborder.synopsis= @movie.synopsis
        %br
        %p 
          = t('.genre')
          %span.badge.alert-info= @movie.genres
        %p
          = t('.releaseDate')
          %span.badge.alert-warning= @movie.release_date
        %p
          = t('.runtime')
          %span.badge.alert-danger= @movie.runtime.to_s + t('.minutes')
        %p
          = t('.averageRating')
          %span.badge= @movie.vote_average.to_s + ' / 10'
        -if current_user && current_user.movies.exists?(id: @movie.id)
          %p
            = t('.yourRating')
            %span.badge.alert-success= @movie.user_rating.to_s + ' / 10'
            %span#edit.glyphicon.glyphicon-edit
          #changeRating{hidden: ''}
            =form_tag movie_path(@movie), method: 'patch', oninput: 'x.value=parseFloat(score.value).toFixed(1)' do
              %input#slidebar{max: '10', min: '0', name: 'score', step: '0.5', type: "range"}
              %output{name: 'x'} 5.0
              = submit_tag 'Submit new rating', class: 'btn btn-default'
        %br
        %p= t('.cast')
        .row
          -i = 0
          -@movie.casts.split(',').each do |cast|
            -i += 1
            .col-sm-4
              -if i < 10
                %li= cast
              -else 
                %li.morecast{hidden: ''}= cast
        -if i > 10
          %a#show= t('.showMore')
      
      #reviews.col-sm-8{hidden: ''}
        %h1#movietitle.textborder 
          = @movie.title
          %a.toggle See Details
        
        -if @reviews.blank?
          %h3 No reviews just yet, would you like to add the first!
          = link_to "Write Review", new_movie_review_path(@movie), class: "btn btn-danger"
        -else   
          %br
          -@reviews.each do |review|
            = User.find(review.user_id).email
            .ratyscore{score: Movie.find(review.movie_id).user_rating}
            = review.comment 
            %hr
          -if current_user and current_user.movies.exists?(api_id: @movie.api_id)
            = link_to "Write Review", new_movie_review_path(@movie), class: "btn btn-danger"

:javascript
  // Star rating plugin by Washington Botelho
  $('#ratyjs').raty({
    path: '/assets/',
    half: true,
    number: 10,
    space: false,
    scoreName: 'user_rating'
  });
  
  // Show review scores as stars
  $('.ratyscore').raty({
    path: '/assets',
    readOnly: true,
    half: true,
    number: 10,
    space: true,
    score: function() {
      return $(this).attr('score')
    }
  })

  
  $(document).ready(function(){
    // Makes raty stars appear on button click
    $('button.btn').click(function(){
      $('#addmovie').toggle();
      $('button.btn').toggle();
    })

    // Makes edit bar appear on button click
    $('#edit').click(function(){
      $('#changeRating').toggle();
    })

    // Buttons disappear to prevent multiple submits while loading
    $('.submit').click(function(){
      $('.submit').toggle();
    })

    // Toggle between movie details and reviews
    $('.toggle').click(function(){
      $('#movieDetails').toggle();
      $('#reviews').toggle();
    })

    // Handles show more/less cast
    $('#show').click(function(){
      var text = 'Show less'
      if ($(this).html() == 'Show less') {
        var text = 'Show more'
      }
      $('.morecast').toggle();
      $(this).html(text);
    })
  });